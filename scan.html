<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>SDERM AI - Scan My Skin</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // Cloudinary upload with metadata (unchanged)
    window.uploadToCloudinary = async function(file, userData) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', 'sderm_uploads');
        formData.append('folder', 'skin-analysis');
        const context = `name=${userData.name}|email=${userData.email}|phone=${userData.phone}|additional_info=${userData.additionalInfo}|submitted_at=${userData.submittedAt}`;
        formData.append('context', context);
        formData.append('tags', `skin-analysis,${userData.name.replace(/\s+/g, '-').toLowerCase()}`);

        const response = await fetch('https://api.cloudinary.com/v1_1/dxnbuc6jh/image/upload', {
          method: 'POST',
          body: formData
        });
        if (!response.ok) throw new Error(`Cloudinary upload failed: ${response.status} ${response.statusText}`);
        const data = await response.json();
        return data.secure_url;
      } catch (err) {
        console.error('Cloudinary upload error:', err);
        throw err;
      }
    };

    // Form submission (demo stub)
    window.submitFormData = async function(formData) {
      try {
        // Replace with your email service/webhook as needed
        return { success: true };
      } catch (err) {
        console.error('Form submit error:', err);
        throw err;
      }
    };
  </script>

  <style>
    html { scroll-behavior: smooth; }
    .nav-scrolled {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(12px);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="font-sans text-gray-900 bg-gray-50">
  <!-- Nav -->
  <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 transition-all duration-300 py-4 px-4 sm:px-6 lg:px-8 nav-scrolled">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <div class="text-white font-bold text-xl"><a href="index.html">SDERM AI</a></div>
      <div class="hidden md:flex space-x-8">
        <a href="index.html" class="text-white hover:text-blue-300 transition font-medium">Home</a>
        <a href="scan.html" class="text-white hover:text-blue-300 transition font-medium">Scan My Skin</a>
        <a href="story.html" class="text-white hover:text-blue-300 transition font-medium">Our Story</a>
        <a href="team.html" class="text-white hover:text-blue-300 transition font-medium">Our Team</a>
        <a href="contact.html" class="text-white hover:text-blue-300 transition font-medium">Contact</a>
      </div>
      <button id="mobile-menu-btn" class="md:hidden text-white focus:outline-none" aria-label="Menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <div id="mobile-menu" class="md:hidden hidden mt-4 pb-4">
      <div class="flex flex-col space-y-3 px-4">
        <a href="index.html" class="text-white hover:text-blue-300 transition font-medium">Home</a>
        <a href="scan.html" class="text-white hover:text-blue-300 transition font-medium">Scan My Skin</a>
        <a href="story.html" class="text-white hover:text-blue-300 transition font-medium">Our Story</a>
        <a href="team.html" class="text-white hover:text-blue-300 transition font-medium">Our Team</a>
        <a href="contact.html" class="text-white hover:text-blue-300 transition font-medium">Contact</a>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <section class="pt-24 pb-16 px-4 sm:px-6 lg:px-8">
    <div class="max-w-4xl mx-auto text-center">
      <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 mb-6">Skin Analysis Upload</h1>
      <p class="text-lg text-gray-600 mb-8">
        Upload a clear image of your skin concern. AI will run and immediately give you a result.
        No one, including us, is able to view your data. All data is deleted immediately after AI analyzes.
      </p>
      <button id="request-demo-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
        Open Uploader
      </button>
    </div>
  </section>

  <!-- Modal -->
  <div id="demo-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-8 max-w-lg w-full mx-4 transform transition-all duration-300 max-h-[90vh] overflow-y-auto">
      <div class="text-center">
        <h3 class="text-2xl font-bold mb-4">Upload Your Skin Image</h3>
        <p class="text-gray-600 mb-6">
          Upload a clear image of your skin concern and AI will analyze it. SDERM AI is fully automated — user-submitted images
          are processed through secure, privacy-preserving AI models. No human views or stores personal health images.
        </p>

        <form id="demo-form" class="space-y-4 text-left">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
            <input name="name" type="text" required placeholder="Enter your full name"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address *</label>
            <input name="email" type="email" required placeholder="Enter your email"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number (Optional)</label>
            <input name="phone" type="tel" placeholder="Enter your phone number"
                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Additional Information (Optional)</label>
            <textarea name="additionalInfo" rows="3" placeholder="Any additional details…"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Upload Skin Image *</label>
            <div id="upload-area" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-400 transition-colors">
              <input type="file" id="image-upload" accept="image/*" required class="hidden">
              <div id="upload-content">
                <p class="text-gray-600 mb-1">Click to upload or drag and drop</p>
                <p class="text-sm text-gray-500">PNG, JPG, JPEG up to 10MB</p>
              </div>
              <div id="image-preview" class="hidden">
                <img id="preview-img" class="max-w-full max-h-32 mx-auto rounded-lg mb-2" alt="preview">
                <p id="file-name" class="text-sm text-gray-600"></p>
                <button type="button" id="remove-image" class="text-red-500 text-sm hover:text-red-700">Remove</button>
              </div>
            </div>
          </div>

          <!-- NEW: Run AI button + result box -->
          <div class="flex items-center justify-between gap-4">
            <button type="button" id="run-ai" class="flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
              Run AI Analysis
            </button>
          </div>
          <div id="ai-result" class="hidden mt-4 border border-green-200 bg-green-50 rounded-lg p-4 text-sm">
            <div class="font-semibold mb-1">AI Result</div>
            <div id="ai-result-text" class="text-gray-800">Processing…</div>
          </div>

          <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div class="text-sm text-blue-800">
              <p class="font-medium mb-1">Image Guidelines:</p>
              <ul class="text-xs space-y-1">
                <li>• Ensure good lighting and clear focus</li>
                <li>• Take photo directly above the skin area</li>
                <li>• Avoid shadows or reflections</li>
                <li>• Include surrounding healthy skin for context</li>
              </ul>
            </div>
          </div>

          <div class="flex space-x-4 pt-2">
            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition">
              Submit for Analysis
            </button>
            <button type="button" id="close-modal" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-400 transition">
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // --- UI elements ---
    const modal = document.getElementById('demo-modal');
    const requestDemoBtn = document.getElementById('request-demo-btn');
    const closeModalBtn = document.getElementById('close-modal');
    const demoForm = document.getElementById('demo-form');
    const uploadArea = document.getElementById('upload-area');
    const imageUpload = document.getElementById('image-upload');
    const uploadContent = document.getElementById('upload-content');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const fileName = document.getElementById('file-name');
    const removeImage = document.getElementById('remove-image');

    // Mobile menu
    document.getElementById('mobile-menu-btn').addEventListener('click', () => {
      document.getElementById('mobile-menu').classList.toggle('hidden');
    });

    // Modal open/close
    function openModal(){ modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
    function closeModal(){ modal.classList.add('hidden'); document.body.style.overflow = 'auto'; resetForm(); }
    function resetForm(){
      demoForm.reset();
      uploadContent.classList.remove('hidden');
      imagePreview.classList.add('hidden');
      uploadArea.classList.remove('border-green-400','bg-green-50');
      uploadArea.classList.add('border-gray-300');
      // Hide AI result box on reset
      document.getElementById('ai-result').classList.add('hidden');
    }
    requestDemoBtn.addEventListener('click', openModal);
    closeModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape' && !modal.classList.contains('hidden')) closeModal(); });

    // Upload handlers
    uploadArea.addEventListener('click', ()=> imageUpload.click());
    uploadArea.addEventListener('dragover', (e)=> { e.preventDefault(); uploadArea.classList.add('border-blue-400','bg-blue-50'); });
    uploadArea.addEventListener('dragleave', (e)=> { e.preventDefault(); uploadArea.classList.remove('border-blue-400','bg-blue-50'); });
    uploadArea.addEventListener('drop', (e)=> {
      e.preventDefault(); uploadArea.classList.remove('border-blue-400','bg-blue-50');
      if (e.dataTransfer.files.length) handleImageUpload(e.dataTransfer.files[0]);
    });
    imageUpload.addEventListener('change', (e)=> { if (e.target.files.length) handleImageUpload(e.target.files[0]); });

    function handleImageUpload(file){
      if (!file.type.startsWith('image/')) return alert('Please upload an image file (PNG, JPG, JPEG)');
      if (file.size > 10 * 1024 * 1024) return alert('File size must be less than 10MB');

      const reader = new FileReader();
      reader.onload = (e)=> {
        previewImg.src = e.target.result;
        fileName.textContent = file.name;
        uploadContent.classList.add('hidden');
        imagePreview.classList.remove('hidden');
        uploadArea.classList.remove('border-gray-300');
        uploadArea.classList.add('border-green-400','bg-green-50');
      };
      reader.readAsDataURL(file);
    }
    removeImage.addEventListener('click', (e)=> {
      e.stopPropagation();
      imageUpload.value = '';
      uploadContent.classList.remove('hidden');
      imagePreview.classList.add('hidden');
      uploadArea.classList.remove('border-green-400','bg-green-50');
      uploadArea.classList.add('border-gray-300');
    });

    // --- Submit (Cloudinary + email/webhook demo) ---
    demoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!imageUpload.files.length) return alert('Please upload an image for analysis');

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Uploading image...';
      submitBtn.disabled = true;

      try {
        const fd = new FormData(demoForm);
        const name = fd.get('name');
        const email = fd.get('email');
        const phone = fd.get('phone') || '';
        const additionalInfo = fd.get('additionalInfo') || '';
        const imageFile = imageUpload.files[0];

        const userData = { name, email, phone, additionalInfo, submittedAt: new Date().toISOString() };
        const imageUrl = await window.uploadToCloudinary(imageFile, userData);

        await window.submitFormData({
          name, email, phone, additionalInfo,
          imageUrl, imageName: imageFile.name,
          submittedAt: userData.submittedAt,
          userAgent: navigator.userAgent, timestamp: Date.now()
        });

        alert('Thanks! Your image has been submitted.');
        closeModal();
      } catch (err) {
        console.error(err);
        alert('Sorry, there was an error. Please try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- AI inference button ---
    const runAiBtn = document.getElementById('run-ai');
    const aiBox = document.getElementById('ai-result');
    const aiText = document.getElementById('ai-result-text');

    // Point to your FastAPI server if deployed elsewhere
    const API_URL = 'http://127.0.0.1:8000/predict';

    runAiBtn.addEventListener('click', async () => {
      if (!imageUpload.files.length) return alert('Please upload an image first');

      runAiBtn.disabled = true;
      const original = runAiBtn.textContent;
      runAiBtn.textContent = 'Analyzing…';
      aiBox.classList.remove('hidden');
      aiText.textContent = 'Running model…';

      try {
        const form = new FormData();
        form.append('file', imageUpload.files[0]);

        const res = await fetch(API_URL, { method: 'POST', body: form });
        if (!res.ok) throw new Error('Server error');
        const data = await res.json();

        const best = data.best;
        const lines = [`Top prediction: ${best.label} (${(best.confidence * 100).toFixed(1)}%)`];
        if (data.top_labels && data.top_labels.length > 1) {
          for (let i = 1; i < data.top_labels.length; i++) {
            lines.push(`${i + 1}) ${data.top_labels[i]} (${(data.top_confidences[i] * 100).toFixed(1)}%)`);
          }
        }
        aiText.innerHTML = lines.join('<br>');
      } catch (err) {
        console.error(err);
        aiText.textContent = 'Error running AI analysis. Make sure the server is running.';
      } finally {
        runAiBtn.textContent = original;
        runAiBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
